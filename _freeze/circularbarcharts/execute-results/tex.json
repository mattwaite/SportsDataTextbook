{
  "hash": "a68884030c2e0efd274c7a2466acfd04",
  "result": {
    "markdown": "# Circular bar charts\n\nAt the 27:36 mark in the [Half Court Podcast](https://www.omaha.com/sports/podcasts/half-court-press/half-court-press-creighton-cruises-in-opener-nebraska-stunned-in/article_67081a35-3a8f-5e9e-ae67-e88fcacbb362.html), former Omaha World Herald Writer Chris Heady said \"November basketball doesn't matter, but it shows you where you are.\"\n\nIt's a tempting phrase to believe, especially a day after Nebraska lost the first game of the Fred Hoiberg era at home to a baseball school, UC Riverside. And it wasn't close. The Huskers, because of a total roster turnover, were a complete mystery before the game. And what happened during it wasn't pretty, so there was a little soul searching going on in Lincoln.\n\nBut does November basketball really not matter?\n\nLet's look, using a new form of chart called a circular bar plot. It's a chart type that combines several forms we've used before: bar charts to show magnitude, stacked bar charts to show proportion, but we're going to add bending the chart around a circle to add some visual interstingness to it. We're also going to use time as an x-axis value to make a not subtle circle of time reference -- a common technique with circular bar charts. \n\nWe'll use a dataset of every college basketball game last season.\n\n\n\n<pre><p><strong>For this walkthrough:</strong></p><p><a href=\"http://mattwaite.github.io/sportsdatafiles/logs20.csv\">\n  <button class=\"btn btn-danger\"><i class=\"fa fa-save\"></i> Download csv file</button>\n</a></p></pre>\n\n\n\nLoad your libraries.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\n```\n:::\n\n\n\nAnd load your data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlogs <- read_csv(\"data/logs20.csv\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nRows: 11097 Columns: 43\n-- Column specification --------------------------------------------------------\nDelimiter: \",\"\nchr   (6): HomeAway, Opponent, W_L, Team, Conference, season\ndbl  (35): Game, TeamScore, OpponentScore, TeamFG, TeamFGA, TeamFGPCT, Team3...\nlgl   (1): Blank\ndate  (1): Date\n\ni Use `spec()` to retrieve the full column specification for this data.\ni Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n:::\n:::\n\n\n\n## Does November basketball matter?\n\nSo let's test the notion of November Basketball Doesn't Matter. What matters in basketball? Let's start simple: Wins.\n\nSports Reference's win columns are weird, so we need to scan through them and find W and L and we'll give them numbers using `case_when`. I'm also going to filter out tournament basketball.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwinlosslogs <- logs |> \n  mutate(winloss = case_when(\n    grepl(\"W\", W_L) ~ 1, \n    grepl(\"L\", W_L) ~ 0)\n) \n```\n:::\n\n\n\nNow we can group by date and conference and sum up the wins. How many wins by day does each conference get?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndates <- winlosslogs |> \n  group_by(Date, Conference) |> \n  summarise(wins = sum(winloss))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'Date'. You can override using the\n`.groups` argument.\n```\n:::\n:::\n\n\n\nEarlier, we did stacked bar charts. We have what we need to do that now.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() + \n  geom_bar(\n    data=dates, \n    aes(x=Date, weight=wins, fill=Conference)\n    ) + \n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](circularbarcharts_files/figure-pdf/unnamed-chunk-6-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nEeek. This is already looking not great. But to make it a circular bar chart, we add `coord_polar()` to our chart.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() + \n  geom_bar(\n    data=dates, \n    aes(x=Date, weight=wins, fill=Conference)\n    ) + \n  theme_minimal() + \n  coord_polar()\n```\n\n::: {.cell-output-display}\n![](circularbarcharts_files/figure-pdf/unnamed-chunk-7-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nBased on that, the day is probably too thin a slice, and there's way too many conferences in college basketball. Let's group this by months and filter out all but the power five conferences. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np5 <- c(\"SEC\", \"Big Ten\", \"Pac-12\", \"Big 12\", \"ACC\")\n```\n:::\n\n\n\nTo get months, we're going to use a function in the library `lubridate` called `floor_date`, which combine with mutate will give us a field of just months.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwins <- winlosslogs |> \n  mutate(month = floor_date(Date, unit=\"months\")) |> \n  group_by(month, Conference) |> \n  summarise(wins=sum(winloss)) |> \n  filter(Conference %in% p5) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'month'. You can override using the\n`.groups` argument.\n```\n:::\n:::\n\n\n\nNow we can use wins to make our circular bar chart of wins by month in the Power Five.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() + \n  geom_bar(\n    data=wins, \n    aes(x=month, weight=wins, fill=Conference)\n    ) + \n  theme_minimal() + \n  coord_polar()\n```\n\n::: {.cell-output-display}\n![](circularbarcharts_files/figure-pdf/unnamed-chunk-10-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nYikes. That looks a lot like a broken pie chart. So months are too thick of a slice. Let's use weeks in our floor date to see what that gives us.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwins <- winlosslogs |> \n  mutate(week = floor_date(Date, unit=\"weeks\")) |> \n  group_by(week, Conference) |> \n  summarise(wins=sum(winloss)) |> \n  filter(Conference %in% p5) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'week'. You can override using the\n`.groups` argument.\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() + \n  geom_bar(\n    data=wins, \n    aes(x=week, weight=wins, fill=Conference)\n    ) + \n  theme_minimal() + \n  coord_polar()\n```\n\n::: {.cell-output-display}\n![](circularbarcharts_files/figure-pdf/unnamed-chunk-12-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nThat looks better. But what does it say? Does November basketball matter? What this is saying is ... yeah, it kinda does. The reason? Lots of wins get piled up in November and December, during non-conference play. So if you are a team with NCAA tournament dreams, you need to win games in November to make sure your tournament resume is where it needs to be come March. Does an individual win or loss matter? Probably not. But your record in November does.\n\n## Does it show you where you are?\n\nSo here is the problem we have:\n\n1. We have data for every game. In the past, we were able to calculate the team wins and losses because the way the data records them is the Team is the main team, and they win or lose. The Opponent is recorded, but the Opponent has the mirror image of this game as well, where they are the Team. So essentially every game is in here twice -- one for each team that plays in the game. \n2. We need to attach the Opponent's winning percentage to each game so we can decide if it's a quality win for Team.\n3. The Team name is not an exact copy of the Team name. So we can't join them using it.\n\nSo what we have to do is invert the process that we've done before. We need to group by the Opponent -- because the names will be consistent then -- and we need to invert the wins and losses. A win in the W_L column is a win for the Team. That means each loss in the W_L column is a WIN for the Opponent. \n\nOnce we invert, the data looks very similar to what we've done before. One other thing: I noticed there's some tournament games in here, so the filter at the end strips them out. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noppwinlosslogs <- logs |> \n  mutate(winloss = case_when(\n    grepl(\"W\", W_L) ~ 0, \n    grepl(\"L\", W_L) ~ 1)\n) |> \n  filter(Date < \"2020-03-19\")\n```\n:::\n\n\n\nSo now we have a dataframe called oppwinlosslogs that has an inverted winloss column. So now we can group by the Opponent and sum the wins and it will tell us how many games the Opponent won. We can also count the wins and get a winning percentage.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noppwinlosslogs |> \n  group_by(Opponent) |> \n  summarise(games=n(), wins=sum(winloss)) |> \n  mutate(winpct = wins/games) -> opprecord\n```\n:::\n\n\n\nNow we have a dataframe of 659 opponent winning records. Wait, what? There's 353 teams in major college basketball, so why 659? If you look through it, there's a bunch of teams playing lower level teams. Given that they are lower level, they're likely cannon fodder and will lose the game, and we're going to filter them out in a minute. \n\nNow we can join the opponent winning percentage to our winlosslogs data so we can answer our question about quality wins.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwinlosslogs <- logs |> \n  mutate(winloss = case_when(\n    grepl(\"W\", W_L) ~ 1, \n    grepl(\"L\", W_L) ~ 0)\n) |> \n  filter(Date < \"2020-03-19\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwinlosslogs |> \n  left_join(opprecord, by=(\"Opponent\")) -> winswithopppct\n```\n:::\n\n\n\nNow that we have a table called winswithopppct, we can filter out teams non power 5 teams and teams that won less than 60 percent of their games and run the same calculations in the book. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np5 <- c(\"SEC\", \"Big Ten\", \"Pac-12\", \"Big 12\", \"ACC\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwinswithopppct |> \n  filter(winpct > .6) |> \n  mutate(week = floor_date(Date, unit=\"weeks\")) |> \n  group_by(week, Conference) |> \n  summarise(wins=sum(winloss)) |> \n  filter(Conference %in% p5) -> qualitywins\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'week'. You can override using the\n`.groups` argument.\n```\n:::\n:::\n\n\n\nNow with our dataframe called qualitywins, we can chart it again.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() + \n  geom_bar(\n    data=qualitywins, \n    aes(x=week, weight=wins, fill=Conference)\n    ) + \n  theme_minimal() + \n  coord_polar()\n```\n\n::: {.cell-output-display}\n![](circularbarcharts_files/figure-pdf/unnamed-chunk-19-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nLook at this chart and compare it to the first one.",
    "supporting": [
      "circularbarcharts_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}